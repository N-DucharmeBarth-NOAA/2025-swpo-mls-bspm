---
title: "Data-moderate assessment approaches for Southwest Pacific Ocean (SWPO) striped marlin"
date: last-modified
date-format: "DD MMMM YYYY"
author:
  - name: "N. Ducharme-Barth"
    affiliations:
      - id: pifsc
        name: "NOAA Fisheries, Pacific Islands Fisheries Science Center, 1845 Wasp Boulevard, Bldg. 176, Honolulu HI 96818"
meetingtype: "SCIENTIFIC COMMITTEE"
meetingnumber: "TWENTY-FIRST REGULAR SESSION"
meetinglocation: "Tonga"
meetingdates: "13-21 August 2025"
repnumber: WCPFC-SC21-2025/SA-IP-XX
format:
  pdf:
    pdf-engine: pdflatex
    template-partials:
      - before-body.tex
    documentclass: SCreport
    fontsize: 11pt
    geometry:
      - margin=1in
    toc: true
    number-sections: true
    link-citations: true
    colorlinks: true
    linkcolor: SCblue
    filecolor: SCblue
    urlcolor: SCblue
    citecolor: SCblue
    toccolor: SCblue
    highlight-style: github
    code-block-bg: "#f6f8fa"
    code-block-border-left: "#c5c5c5"
    code-font: "Consolas, Monaco, 'Andale Mono', monospace"
    filters:
      - inline-code.lua
    header-includes: |
     \usepackage{draftwatermark}
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    link-citations: true
    colorlinks: true
    highlight-style: github
    self-contained: true
bibliography: 202506_swpo_bayes.bib
csl: apa.csl

---

```{=html}
<style>
.draft-watermark {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-45deg);
  font-size: 100px;
  font-weight: bold;
  color: #ccc;
  opacity: 0.5;
  z-index: -1000;
  pointer-events: none;
}
</style>
<div class="draft-watermark">DRAFT</div>
```

```{r}
#| label: set-paths
#| echo: false
#| warning: false
#| message: false

proj_dir = this.path::this.proj()
dir_model_runs = file.path(proj_dir,"data","output","model_runs")
```

\newpage

# Executive summary

\newpage

# Introduction {#sec-introduction}

Assessment of Southwest Pacific Ocean (SWPO) striped marlin (*Kajikia audax*) has been challenging. As documented in the joint NOAA-SPC modeling meeting report [@ducharme-barth_summary_2025], key issues identified by WCPFC SC20 included poor fits to size composition data and relative abundance indices, conflicts between different data sources, and difficulties in estimating model initial conditions.

Discussions at the 2025 SPC Pre-Assessment Workshop also highlighted challenges related to the estimation of total population scale, where the low biomass scale indicated by previous versions of the assessment appears largely driven by the size composition from multiple fisheries. While estimation of low biomass scale is not inherently problematic, the resulting high ratio of fishing mortality (F) to natural mortality (M) that is maintained over multiple decades in the face of relative stability in catches and catch-per-unit-effort (CPUE) is suspicious and potentially indicative of additional model mis-specification.

The complexity of integrated age-structured models, while providing detailed population dynamics representation, can become problematic when fundamental data conflicts exist or when key biological parameters are uncertain. For SWPO striped marlin, these challenges are compounded by spatiotemporal heterogeneity in fleet coverage, potential non-representativeness in mixed-fleet composition data, and limitations in age data from opportunistic sampling. In the current case, changes to productivity (growth, natural mortality, maturity, and/or steepness) or selectivity assumptions will impact biomass scaling through predictions of expected size composition data.

Scaling back model complexity to a *data-moderate* approach, like Bayesian surplus production models (BSPMs), offers analysts a simplified yet robust alternative for stock assessment when data limitations or conflicts present challenges for more complex models. These models have proven effective in recent pelagic fish stock assessments [@winker_jabba_2018], and are routinely applied for WCPFC shark assessments [@neubauer_alternative_2019;@isc_stock_2024;@neubauer_stock_2024]. They also facilitate a more tractable exploration of model assumptions by distilling productivity and fishing assumptions into a restricted parameter subset. The BSPM framework allows for explicit incorporation of parameter uncertainty through informative priors while maintaining computational efficiency and interpretability.

One of the advantages of the Bayesian approach is through the use of prior information to propagate uncertainty in model assumptions, and biological simulation approaches can provide a robust methods for parameterizing key population dynamics parameters [@pardo_maximum_2016;@isc_stock_2024]. For species with complex life histories like striped marlin, these simulation-based priors can incorporate uncertainty in growth, maturity, natural mortality, and reproductive parameters to derive realistic distributions for maximum intrinsic rate of increase and carrying capacity. Additionally, prior pushforward checks can be used to further refine parameter distributions by identifying parameter combinations that produce clearly improbable outcomes.

This analysis presents a data-moderate approach for SWPO striped marlin that addresses some of the key technical challenges identified in previous assessments while providing a robust framework for stock status evaluation. The model incorporates biological uncertainty through simulation-based priors and includes approaches to address catch uncertainty and population depletion. It is important to note that this analysis complements the 2025 revised stock assessment report [@castillo-jordan_revised_2025]. While the relative simplicity of data-moderate approaches offer some advantages relative to more data-intensive approaches like fully-integrated age-structured stock assessment models, particularly when uncertainty in data or key assumptions are high, this comes at the cost of simplifying the model fishery and population dynamics. Over-simplification of key age-structured processes, or lack of spatiotemporal specificity could result in biases in data-moderate approaches. Taking multiple modeling approaches into account can give managers a holistic view on the likely status and trajectory of the stock.

# Methods {#sec-methods}

## Model Framework {#sec-model-framework}

In order to address some of the issues raised in @sec-introduction, a series of Bayesian state-space surplus production models (BSPMs) spanning the period 1952-2022 were developed following the Fletcher-Schaefer production model framework [@winker_unifying_2020; @edwards_bdm_2024]. Development of the BSPM followed the approach of [@neubauer_alternative_2019;@isc_stock_2024] and incorporated recent best practices for surplus production models [@kokkalis_good_2024] and Bayesian workflows for stock assessment [@monnahan_toward_2024] as guides for model development, analysis, and presentation.

The models were implemented in the Stan probabilistic programming language [@stan_development_team_stan_2024] to take advantage of enhanced convergence diagnostics, greater efficiency in posterior sampling through the no-U-turn (NUTS) Hamiltonian Monte Carlo algorithm [@betancourt_hamiltonian_2013], and greater flexibility with model configuration and prior specification. Implementation in R using the *rstan* package [@stan_development_team_rstan_2024] provides connection to an ecosystem of additional R packages for model diagnostics and validation: *bayesplot* [@gabry_bayesplot_2024] for posterior visualization and *loo* [@vehtari_loo_2024].

The model begins from an assumed unfished state in 1952 and incorporates process error in population dynamics, observation error in abundance indices, and uncertainty in biological parameters. Several model variants were developed: a baseline model (`0001-2024cpueExPrior`), a depletion-constrained model (`0002-2024cpueDepPrior`) that incorporates additional information about historical stock status from mean size data, and an extension of the depletion-constrained model that assumes a different prior on the variability in fishing mortality (`0003-2024cpueFPrior`). The `0002-2024cpueDepPrior` and `0003-2024cpueFPrior` models include a mean weight based prior on 1988 depletion, and more detail on the development of this prior can be found in @sec-depletion-prior. Unless otherwise mentioned, all models used the same prior parameterizations (@tbl-priors) based on the biological simulation filtering described in @sec-prior-development.

### Input data {#sec-input-data}

The BSPM was fit to catch and standardized CPUE data for SWPO striped marlin. Annual catch data (in numbers) spanning 1952-2022 were compiled from the 2024 assessment [@castillo-jordan_stock_2024] sources and aggregated into total removals by year. 

The catch series (@fig-annual-catch) shows initial low removals in 1952-1953, followed by a high peak in 1954. Overall, however, catches have been relatively stable though catches in recent decades show a slight decline. A single standardized CPUE index (1988-2022) from the diagnostic case of the 2024 assessment [@castillo-jordan_stock_2024] was used. The index is very noisy (@fig-idx-fit). In general, however, there is a slight declining trend over the index period. The decline was most pronounced after 2000, though the trend  stabilized somewhat, prior to showing a slight increase in recent years. 

### Population Dynamics {#sec-population-dynamics}

The population dynamics follow a Fletcher-Schaefer surplus production model with state-space formulation where population depletion $x_t$ (relative to carrying capacity $K$) evolves according to:

$$x_t = \begin{cases} 
(x_{t-1} + R_{max} x_{t-1} (1 - \frac{x_{t-1}}{h}) - C_{t-1}) \times \epsilon_t, & x_{t-1} \leq D_{MSY} \\
(x_{t-1} + x_{t-1}(\gamma \times m)(1 - x_{t-1}^{n-1}) - C_{t-1}) \times \epsilon_t, & x_{t-1} > D_{MSY}
\end{cases}$$

where $R_{max}$ is the maximum intrinsic rate of increase, $n$ is the shape parameter, and $\epsilon_t$ represents multiplicative process error with $\epsilon_t = \exp(\delta_t - \sigma_P^2/2)$ and $\delta_t \sim N(0, \sigma_P)$. The intermediate parameters are: $D_{MSY} = (1/n)^{1/(n-1)}$, $h = 2D_{MSY}$, $m = R_{max}h/4$, and $\gamma = n^{n/(n-1)}/(n-1)$.

### Observation Model {#sec-observation-model}

The model fits to a standardized CPUE index using a lognormal likelihood:

$$I_t \sim \text{Lognormal}(\log(q \times x_t) - \frac{\sigma_{O,t}^2}{2}, \sigma_{O,t})$$

where catchability $q$ is analytically derived assuming an uninformative uniform prior, and total observation error $\sigma_{O,t} = \sigma_{O,input} + \sigma_{O,add}$ combines fixed input uncertainty with an estimated additional error component.

### Catch Treatment {#sec-catch-treatment}

Annual fishing mortality is estimated directly $F_t \sim N^+(0, \sigma_F)$ with catch fitted using lognormal likelihood with uncertainty $\sigma_C = 0.2$

Catch is predicted as:
$$C_t = (x_t + \text{surplus production}_t) \times (1 - \exp(-F_t)) \times \epsilon_t \times K$$

## Prior Development {#sec-prior-development}

### Biological Simulation Framework {#sec-biological-simulation}

Informative priors for key population parameters were developed through biological simulation using Monte Carlo sampling from biologically plausible parameter distributions. The simulation framework incorporated uncertainty and correlations in life history parameters:

- **Growth parameters**: Francis parameterization with independent sampling
- **Natural mortality**: Reference mortality $M_{ref}$ negatively correlated with maximum age (r = -0.3)
- **Maturity**: Length-based logistic function parameters
- **Reproduction**: Steepness parameter for stock-recruit relationship and sex ratio
- **Weight-length relationship**: Correlated allometric parameters (r = -0.5) with biological constraints
- **Fishery selectivity**: Length at first capture for depletion prior

Parameter combinations (@tbl-bio-params) were filtered to ensure biological realism and included correlations between life history parameters reflecting biological trade-offs (e.g., shorter lived individuals having higher natural mortality rates).

### Maximum Intrinsic Rate of Increase ($R_{max}$) Prior {#sec-rmax-prior}

$R_{max}$ was calculated by numerically solving the Euler-Lotka equation using bounded optimization (nlminb function in R) to find the value of $R_{max}$ that satisfies the equation within convergence criteria. Starting values and bounds were set to ensure biologically realistic solutions. Formulation of the Euler-Lotka equation followed the approach implemented in openMSE [@stanley_stock_2009;@hordyk_openmse_2024]:

$\alpha \sum_{a=1}^{A_{max}} l_a f_a \exp(-R_{max} \times a) = 1$

where $\alpha$ is the slope at the origin of the stock-recruitment curve, $l_a$ is the probability of survival to age $a$, and $f_a$ is the fecundity (reproductive output) at age $a$. Additional technical detail can be found in @sec-equilibrium-dynamics of the Technical Annex.

Repeating this calculation across each of the 500,000 parameter combinations resulted in a prior distribution of $R_{max}$ conditioned on plausible biology and life-history characteristics. The resulting distribution was first filtered to values of $R_{max} < 1.5$ representative of what the literature [@hutchings_lifehistory_2012;@gravel_metabolism_2024] indicates is most likely for teleosts. A prior pushforward analysis, similar to [@isc_stock_2024], was used to further refine this distribution and develop a lognormal prior for $R_{max}$. Briefly, random values of $R_{max}$ along with random values of the other leading parameters of the BSPM (drawn from the prior distributions described in @tbl-priors) were used to drive simulated populations forward subject to direct removal of the observed catch (@fig-annual-catch). Based on the results of the prior pushforward (@fig-pushforward), the $R_{max}$ distribution was further filtered based on the following criteria:

- Depletion in the terminal year $>$ 2% and $R_{max} < 1$
- Depletion in the terminal year $>$ 2%, $R_{max} < 1$, and trend in depletion over the last decade between -5% and 10%

This last filtering step approximates the recent relative trend seen in the index (@fig-idx-fit). Fitting a lognormal distribution to the remaining $R_{max}$ values results in the prior distribution specified in @tbl-priors and shown in @fig-rmax-prior. Note that though initial filtering restricted $R_{max}<1$ the final lognormal prior still assigns some prior weight to $R_{max}>1$.  

### Depletion Prior {#sec-depletion-prior}

It is not possible to fit to size composition data in a BSPM framework, however information on fishing mortality and depletion may be contained in the long time series of New Zealand recreational fishing data. This fishery routinely catches the largest individuals and shows a decline in average size since the start of the model period (@fig-gedamke), prior to which limited large-scale commercial fishing occurred. Assuming constant availability and selectivity, declining mean weight can be an indication of increased mortality. Assuming natural mortality M has remained constant, this indicates that the population may be in a more depleted state than in the initial period. The `0002-2024cpueDepPrior` variant was developed to capitalize on this potential additional source of information.

A supplementary analysis was used to estimate relative population depletion in 1988 using New Zealand recreational fishing weight data. A modified Gedamke-Hoenig approach [@gedamke_estimating_2006] for using size composition data to estimate mortality in non-equilibrium situations was applied to estimate change in total mortality from $Z_1$ (initial period) to $Z_2$ (final period) at a known change point (1952) when industrial fishing commenced at the start of the model period (more detail in Technical Annex @sec-transitional-weight-model). These two total mortality rates were calculated for each of the biological parameter combinations described in @sec-biological-simulation and used to calculate relative spawning stock biomass depletion as the ratio of spawning potential under the two mortality regimes:

$$\text{Relative Depletion} = \frac{SPR_{Z_2}}{SPR_{Z_1}} = \frac{\sum_{a=1}^{A_{max}} l_{a,Z_2} f_a}{\sum_{a=1}^{A_{max}} l_{a,Z_1} f_a}$$

where $l_{a,Z}$ is survival to age $a$ under total mortality $Z$, and $f_a$ is reproductive output at age $a$ (incorporating maturity, weight, sex ratio, and reproductive cycle). Additional technical detail on the population dynamics components of this equation can be found in @sec-equilibrium-dynamics of the Technical Annex.

The resulting depletion estimates across successful parameter combinations were used to construct an informative lognormal prior for stock depletion that could be applied in the BSPM in 1988 (@fig-dep-prior).

### Fishing mortality prior {#sec-sigmaF-prior}

An extension of the prior pushforward analysis described in @sec-rmax-prior was applied to develop a prior for the variability in fishing mortality $\sigma_F$. While in @sec-rmax-prior the catch was subtracted directly, a random distribution of $\sigma_F ~ \mathnormal{Normal}^+(0,0.1)$ values were used to develop time series of fishing mortality values. Based on the random fishing mortality values, catch was calculated and removed from the population in the same way as described in @sec-catch-treatment. Based on the results of the prior pushforward, the $\sigma_F$ distribution was further filtered based on the same criteria used in @sec-rmax-prior with the additional criteria that:

- Depletion in the terminal year $>$ 2%, $R_{max} < 1$, trend in depletion over the last decade between -5% and 10%, and maximum simulated catch was less than 350,000.

This last filtering step was done to ensure that observed catch values fell within the $95^{th}$ percentile of the simulated catch, and with a median simulated catch that approximated the magnitude of observed catches [FIGURE]. Fitting a $\mathnormal{Normal}^+$ distribution to the remaining $\sigma_F$ values results in the prior distribution specified in [@tbl-priors; UPDATE TABLE] and shown in [FIGURE]. While all parameters (e.g., $R_{Max}$ and $logK$) were subject to this new filtering step only the $\sigma_F$ distribution showed meaningful change. Therefore, when setting up the `0003-2024cpueFPrior` model prior distributions for the non-$\sigma_F$ parameters were assumed to be the same as the other two models.

## Model Implementation {#sec-model-implementation}

```{r}
#| label: read-model-config
#| echo: false
#| warning: false
#| message: false

# Read model configuration data
library(data.table)
model_config <- fread(file.path(dir_model_runs, "0001-2024cpueExPrior_0", "settings.csv"))

# Extract values for inline use
n_chains <- model_config$chains
iter_total <- model_config$iter_total
burnin_prop <- model_config$burnin.prop
n_thin <- model_config$n_thin
adapt_delta <- model_config$adapt_delta
max_treedepth <- model_config$max_treedepth
iter_keep <- model_config$iter_keep

# Calculate derived values
warmup_iter <- burnin_prop*n_thin*iter_keep
post_warmup_iter <- iter_total - warmup_iter
final_sample_size <- (post_warmup_iter / n_thin) * n_chains
```

Models were implemented using the No-U-Turn Sampler (NUTS) in Stan. Each model was run using `r n_chains` independent Markov chains with randomly generated starting values to ensure robust exploration of the posterior parameter space. Each chain was sampled for `r format(iter_total, big.mark = ",")` iterations, with the first `r format(warmup_iter, big.mark = ",")` iterations discarded as warmup to allow for algorithm adaptation. To reduce posterior sample autocorrelation and storage requirements, every `r n_thin` samples was retained from the post-warmup iterations, yielding a final sample size of `r format(final_sample_size, big.mark = ",")` draws from the joint posterior distribution across all chains. The NUTS algorithm was configured with strict adaptation parameters to ensure reliable convergence. The adaptation delta was set to `r adapt_delta` to reduce the step size and minimize divergent transitions, while the maximum tree depth was increased to `r max_treedepth` to allow for longer trajectories during the dynamic sampling process.

Model convergence and performance were assessed using multiple diagnostic criteria recommended for Bayesian stock assessment workflows [@monnahan_toward_2024]. The potential scale reduction factor ($\hat{R}$) was required to be less than 1.01 for all parameters, indicating convergence across chains. Effective sample sizes were required to exceed 500 to ensure adequate precision in posterior estimates. Additionally, posterior predictive checks were conducted to evaluate model adequacy through comparison of observed versus predicted index and catch values, while parameter identifiability was assessed through visual examination of posterior distributions and correlation structures among estimated parameters [@gabry_visualization_2019].

## Model Diagnostics {#sec-model-diagnostics}

Model performance was comprehensively evaluated using multiple diagnostic criteria recommended for Bayesian stock assessment workflows [@monnahan_toward_2024]. The diagnostic framework included Stan model convergence criteria, data fits, posterior predictive checks, retrospective analysis, and hindcast cross-validation.

### Convergence Diagnostics {#sec-convergence-diagnostics}

Conventional Stan model convergence diagnostics and thresholds were employed to identify whether posterior distributions were representative and unbiased [@monnahan_toward_2024]. Models were considered to have 'converged' to a stable, unbiased posterior distribution if they satisfied the following criteria:

- **Potential scale reduction factor** ($\hat{R}$) less than 1.01 for all leading model parameters, indicating convergence across chains
- **Bulk effective sample size** ($N_{eff}$) greater than 500 for all leading model parameters, ensuring adequate precision in posterior estimates  
- **No divergent transitions** during the NUTS sampling process, which can indicate problematic posterior geometry
- **Maximum tree depth** not exceeded during sampling, ensuring adequate exploration of parameter space


Additionally, trace plots and rank plots were examined to visually assess mixing and convergence behavior across chains [@gabry_visualization_2019].

### Data Fits {#sec-data-fits}

Model fit to the abundance index was quantified using normalized root-mean-squared error (NRMSE):

$$RMSE = \sqrt{\frac{\sum_{i=1}^{n} (y_i - \hat{y}_i)^2}{n}}$$

$$NRMSE = \frac{RMSE}{\sum_{i=1}^{n} y_i / n}$$

where $y_i$ are the observed values and $\hat{y}_i$ are the model predictions. The average NRMSE across all posterior samples was calculated for each data component. Additionally, Probability Integral Transform (PIT) style residuals were calculated for the fit to the index.

### Posterior Predictive Checks {#sec-posterior-predictive-checks}

Posterior predictive checks were conducted to evaluate model adequacy by comparing observed data with data simulated from the fitted model. For each posterior sample, synthetic datasets were generated using the estimated parameters, and agreement between observed and predicted datasets was assessed visually.

### Retrospective Analysis {#sec-retrospective-analysis}

Retrospective analysis was conducted for each model by sequentially peeling off a year from the terminal end of the fitted index and re-running the model. Data were removed for each year up to five years from 2022 to 2018. Estimates of $x$ in the terminal year of each retrospective peel were compared to the corresponding estimate of $x$ from the full model run to better understand any potential biases or uncertainty in terminal year estimates. The Mohn's $\rho$ statistic [@mohn_retrospective_1999] was calculated and presented. This statistic measures the average relative difference between an estimated quantity from an assessment (e.g., depletion in final year) with a reduced time-series of information and the same quantity estimated from an assessment using the full time-series.

Additionally, following @kokkalis_good_2024 the proportion of retrospective peels (or coverage) where the relative exploitation rate ($U/U_{MSY}$) and relative depletion ($D/D_{MSY}$) were inside the credible intervals of the full model run was calculated. This metric provides an additional perspective on retrospective consistency by evaluating whether the uncertainty estimates from the full model appropriately capture the range of estimates obtained when using reduced datasets.

### Hindcast Cross-Validation {#sec-hindcast-cross-validation}

Hindcast cross-validation [@kell_validation_2021] was conducted for each index to determine the performance of the model to predict the observed CPUE $I$ one-step-ahead into the future relative to a naïve predictor. Briefly, the 'model-free' approach to hindcast cross-validation was used, and made use of the same set of five retrospective peels described in @sec-retrospective-analysis. 

The 'model-free' hindcast calculation is described using the model from the last peel $BSPM_{2017}$ as an example. This model fit to index data through 2017 but included catch through 2022. The model estimates of predicted CPUE in 2018 based on $BSPM_{2017}$ is the 'model-free' hindcast for 2018, $\hat{I}_{2018}$. The naïve prediction of CPUE in 2018 is simply the observed CPUE from 2017, $I_{2017} = \ddot{I}_{2018}$. The absolute scaled error (ASE) of the prediction is:

$ASE_{2018} = \frac{|I_{2018} - \hat{I}_{2018}|}{|I_{2018} - \ddot{I}_{2018}|}$

Repeating this calculation across all retrospective peels for years 2019-2022 and taking the average across ASE values gives the mean ASE or MASE for the model. An MASE value less than one indicates that the model has greater predictive skill than the naïve predictor.

## Forecasts

Simple, status quo catch based stochastic projections over a 10 year window are provided for each model. For each model, projected catch was taken as the average catch over the terminal 5 years (2018-2022). Process error in the projection period was randomly resampled from the estimated process error in the main model period.

# Results {#sec-results}

```{r}
#| label: read-model-diagnostics
#| echo: false
#| warning: false
#| message: false

# Read summary diagnostics
library(data.table)
summary_diagnostics <- fread(file.path(proj_dir, "data", "output", "summary_retro0.csv"))

# Extract diagnostics for both models
baseline <- summary_diagnostics[run_number == "0001-2024cpueExPrior"]
constrained <- summary_diagnostics[run_number == "0002-2024cpueDepPrior"]

# Read stan data to get catch CV
stan_data <- fread(file.path(proj_dir, "data", "output", "model_runs", "0001-2024cpueExPrior_0", "stan_data.csv"))
catch_cv <- stan_data[name == "sigmac" & type == "Data"]$value
```

## Model Convergence and Diagnostics {#sec-model-convergence}

Both BSPM model variants (`0001-2024cpueExPrior` and `0002-2024cpueDepPrior`) achieved satisfactory convergence based on standard Hamiltonian Monte Carlo diagnostics (@tbl-summary). Both models met all convergence criteria with $\hat{R}$ values well below the 1.01 threshold and effective sample sizes exceeding the recommended minimum of 500 (100 samples per chain). No divergent transitions were observed across chains, and maximum tree depth was not exceeded during sampling, which did not indicate issues in exploring the posterior space.

### Model Fit to Data {#sec-model-fit}

#### Catch Data Fit

Both models were fit to the observed catch time series (1952-2022) with a coefficient of variation of `r catch_cv` applied to account for uncertainty in catch estimates. Given that the fishing mortality required to fit the catch was also directly estimated, model fit to the catch was good (@fig-pred-catch). Notably, the models predicted lower than observed catch for the large catch event in 1954. 

#### CPUE Index Fit

Model fit to the standardized CPUE index (1988-2022) was evaluated using normalized root-mean-squared error (NRMSE). Both models provided reasonable fits to the observed index given the high variability and observation error (@tbl-summary). The `0002-2024cpueDepPrior` model showed marginally improved fit to the CPUE index, with lower RMSE values. In general, both models successfully captured the general declining trend in the standardized CPUE from 1988-2022. However, the estimated combination of observation and process error meant that the model was not pulled as tightly to each individual observation resulting in a persistant overfit in the last decade (e.g., negative residuals @fig-idx-residuals). Posterior predictive checks confirmed that the models were able to replicate the key features of the observed CPUE data (@fig-idx-fit).

### Model Validation {#sec-model-validation}

Overall retrospective bias was very low, and close to 0 for both models (@tbl-summary; @fig-retro) indicating a lack of persistant bias in terminal estimates as successive years of the index were removed from the model. Additionally, estimates of the relative exploitation rate ($U/U_{MSY}$) and relative depletion ($D/D_{MSY}$) were inside the credible intervals of the full model run 100% of the time (@tbl-summary). In terms of hindcast cross validation, both models (though `0002-2024cpueDepPrior` model showed marginally better performance) slightly exceeded the performance of the naïve predictor (@tbl-summary; @fig-hcxval) which provides some support that the model has identified and estimated a production for the stock.

## Population Dynamics and Stock Status {#sec-stock-status}

In both models, most leading parameters (*log(K)*, $R_{max}$, $\sigma_P$, $n$, $\sigma_F$, and $\sigma_{O,add}$) showed posterior update from their respective prior distributions (@fig-prior-post), indicating that there was sufficient information in the data to impact parameter estimates. The shape parameter $n$ showed little deviation from the Schaefer-model prior. Both models estimated similar levels of $\sigma_P$ and additional observation error $\sigma_{O,add}$ (@tbl-param-hmc) which is unsurprising given that they fit to the same catch and standardized index. Though estimates of $\sigma_P$ were elevated from the prior, the model mainly reconciled the variability in the index by estimating substantial additional observation error $\sigma_{O,add}$ resulting in a roughly 3:1 of total observation error $\sigma_O$ to process error $\sigma_P$. Similar to what was seen in @isc_stock_2024, there was a trade-off between *log(K)* and $\sigma_F$ where the `0001-2024cpueExPrior` model estimated higher population scale and lower fishing mortality relative to the `0002-2024cpueDepPrior` model.

Substantial posterior update was shown for the $R_{max}$ parameter where both models estimated productivity on the lower end of the biological prior. These median estimates of $R_{max}$, between 0.2 - 0.3 (@tbl-param-hmc), are not completely inconsistent, with estimates of $R_{max}$ for an analagous species in the Atlantic Ocean, white marlin (*Kajikia albida*). Based on the most recent ICCAT assessment [@iccat_report_2020] implemented using JABBA [@winker_jabba_2018], $R_{max}$ was estimated to be 0.163 (0.122 - 0.215 95% credible interval) which is contained within the posterior estimates of both the `0001-2024cpueExPrior` and `0002-2024cpueDepPrior` models (@tbl-param-hmc). In the case of the Atlantic white marlin assessment, the JABBA model showed remarkable consistency with estimates of stock status and trend relative to a fully integrated, length structured model implemented in Stock Synthesis [@iccat_report_2020]. Returning to the current analysis, a lower level of productivity $R_{max}$ was estimated, with less uncertainty (@tbl-param-hmc), for the `0002-2024cpueDepPrior` model assuming a more depleted stock. Filtering the original biological prior to match the $R_{max}$ posterior distribution from the `0002-2024cpueDepPrior` model using an inverse transform sampling approach identifies that this lower productivity is characterized by a pronounced shift to lower steepness values $h$ and by a lesser extent to smaller values of von Bertalanffy $k$ (@fig-rmax-subsample-bio).

[Trends & $x_{1988}$]

## Biological Reference Points {#sec-reference-points}

[MSY-based reference points (MSY, D_MSY, U_MSY, F_MSY) estimated from both model variants.]

## Future Projections {#sec-projections}

[Ten-year stochastic projections under different catch scenarios and associated risk assessments.]

# Discussion {#sec-discussion}

# Declaration of Generative AI use {#sec-ai-declaration}

A generative artificial intelligence (AI) assistant, Anthropic Claude Sonnet 4.0, was used to parse model code in the preparation of an initial draft of this report.

# References {#sec-refs}

::: {#refs}
:::

\newpage

```{=html}
<br>
```

::: {.landscape}

# Tables {#sec-tables}

Table: Biological parameter distributions and sources used in simulation framework {#tbl-bio-params}

| Parameter | Symbol | Distribution | Mean/Mode | CV/Range | Correlation | Source/Notes |
|-----------|--------|--------------|-----------|----------|-------------|--------------|
| Length at age 1 | $L_1$ | Lognormal | 60 cm | 0.2 | Independent | [@ducharme-barth_summary_2025] |
| Length at age 10 | $L_2$ | Lognormal | 210 cm | 0.2 | Independent | [@ducharme-barth_summary_2025] |
| Growth coefficient | $k$ | Beta(6.5, 3.5) | ~0.65 | - | Independent | [@ducharme-barth_summary_2025] |
| Length CV | $cv_{len}$ | Uniform | - | [0.05, 0.25] | - | Growth variability |
| Maximum age | $A_{max}$ | Lognormal | 15 years | 0.2 | $\rho$ = -0.3 with $M_{ref}$ | [@farley_southwest_2021] |
| Reference mortality | $M_{ref}$ | Lognormal | 0.36 $yr^{-1}$ | 0.44 | $\rho$ = -0.3 with $A_{max}$ | [@hamel_development_2022] (5.4/$A_{max}$) |
| Maturity slope | $a_{mat}$ | Normal | -20 | 0.2 | - | Logistic steepness |
| Length at 50% maturity | $L_{50}$ | Lognormal | 184 cm | 0.2 | - | [@farley_southwest_2021] |
| Weight coefficient | $a_w$ | Lognormal | $5.4\times10^{-7}$ | 0.05 | $\rho$ = -0.5 with $b_w$ | [@castillo-jordan_stock_2024] |
| Weight exponent | $b_w$ | Normal | 3.58 | 0.05 | r = -0.5 with $a_w$ | [@castillo-jordan_stock_2024] Constrained: 150-350 kg at 300 cm |
| Steepness | $h$ | Beta(3, 1.5) | ~0.73 | - | - | Censored to [0.2, 1.0] |
| Sex ratio (prop. female) | $s$ | Normal | 0.5 | 0.05 | - | Constrained [0.01, 0.99] |
| Reproductive cycle | - | Fixed | 1 year | - | - | Annual spawning |
| Length at first capture | $L_c$ | Lognormal | 140 cm | 0.125 | - | Fishery selectivity |
| Reference ages | $age_1$, $age_2$ | Fixed | 0, 10 years | - | - | Francis parameterization |

:::

\newpage

```{=html}
<br>
```

```{r}
#| label: read-priors-data
#| echo: false
#| warning: false
#| message: false

# Read and process Stan data to extract prior values
library(data.table)

# Read the CSV file
stan_data <- fread(file.path(dir_model_runs,"0002-2024cpueDepPrior_0","stan_data.csv"))

# Filter for prior means and standard deviations
prior_data <- stan_data[type %in% c("PriorMean", "PriorSD")]

# Reshape to have mean and SD in separate columns
prior_table <- dcast(prior_data, name ~ type, value.var = "value")

# Extract individual prior values for inline use
PriorMean_logK <- prior_table[name == "logK"]$PriorMean
PriorSD_logK <- prior_table[name == "logK"]$PriorSD
PriorMean_logr <- prior_table[name == "logr"]$PriorMean
PriorSD_logr <- prior_table[name == "logr"]$PriorSD
PriorMean_logshape <- prior_table[name == "logshape"]$PriorMean
PriorSD_logshape <- prior_table[name == "logshape"]$PriorSD
PriorMean_logsigmap <- prior_table[name == "logsigmap"]$PriorMean
PriorSD_logsigmap <- prior_table[name == "logsigmap"]$PriorSD
PriorSD_sigmao_add <- prior_table[name == "sigmao_add"]$PriorSD
PriorSD_sigmaf <- prior_table[name == "sigmaf"]$PriorSD

# Extract depletion priors
depletion_meanlog <- stan_data[name == "prior_depletion_meanlog"]$value
depletion_sdlog <- stan_data[name == "prior_depletion_sdlog"]$value
```

::: {.landscape}

Table: Prior distributions for Bayesian surplus production model parameters {#tbl-priors}

| Parameter | Distribution | Mean | SD | Description |
|-----------|-------------|------|----|-----------| 
| **Core Population Parameters** | | | | |
| $K$ | Lognormal | $\log(`r format(round(exp(PriorMean_logK), 0), big.mark = ",")`)$ | `r round(PriorSD_logK, 2)` | Carrying capacity |
| $R_{max}$ | Lognormal | $\log(`r round(exp(PriorMean_logr), 4)`)$ | `r round(PriorSD_logr, 2)` | Maximum intrinsic rate of increase (from biological simulation) |
| $n$ | Lognormal | $\log(`r round(exp(PriorMean_logshape), 3)`)$ | `r round(PriorSD_logshape, 2)` | Shape parameter (Pella-Tomlinson production function); $n = 2$ is a Schaefer model |
| | | | | |
| **Process and Observation Error** | | | | |
| $\sigma_P$ | Lognormal | $\log(`r round(exp(PriorMean_logsigmap), 4)`)$ | `r round(PriorSD_logsigmap, 2)` | Process error standard deviation [@winker_jabba_2018] |
| $\sigma_{O,add}$ | Half-Normal | 0 | `r round(PriorSD_sigmao_add, 2)` | Additional estimated observation error |
| $\sigma_F$ | Half-Normal | 0 | `r round(PriorSD_sigmaf, 3)` | Fishing mortality variability |
| | | | | |
| **Depletion Constraint (Constrained Model Only)** | | | | |
| $x_{1988}$ | Lognormal | $\log(`r round(exp(depletion_meanlog), 4)`)$ | `r round(depletion_sdlog, 2)` | Initial depletion at $t=37$ (this analysis) |

:::

\newpage

```{=html}
<br>
```

::: {.landscape}

Table: Model summary {#tbl-summary}

| Model | Max $\hat{R}$ | Min ESS | Divergent | Tree Depth | BFMI Issues | Index RMSE | Mohn's $\rho$ | MASE | Coverage $D/D_{MSY}$ | Coverage $U/U_{MSY}$ |
|-------|---------------|---------|-----------|------------|-------------|-------------|---------------|------|--------------------|-------------------|
| `0001` | `r round(baseline$max_rhat, 3)` | `r round(baseline$min_neff*1000)` | `r baseline$divergent` | `r baseline$treedepth` | `r baseline$low_bfmi` | `r round(baseline$median_rmse, 3)` | `r round(baseline$retro, 3)` | `r round(baseline$hcxval, 3)` | `r round(baseline$coverage_pmsy*100, 1)`% | `r round(baseline$coverage_fmsy*100, 1)`% |
| `0002` | `r round(constrained$max_rhat, 3)` | `r round(constrained$min_neff*1000)` | `r constrained$divergent` | `r constrained$treedepth` | `r constrained$low_bfmi` | `r round(constrained$median_rmse, 3)` | `r round(constrained$retro, 3)` | `r round(constrained$hcxval, 3)` | `r round(constrained$coverage_pmsy*100, 1)`% | `r round(constrained$coverage_fmsy*100, 1)`% |

**Notes:** 

`0001` corresponds to the `0001-2024cpueExPrior` model

`0002` corresponds to the `0002-2024cpueDepPrior` model

- Max $\hat{R}$: Maximum potential scale reduction factor across all parameters (should be < 1.01)
- Min ESS: Minimum effective sample size across all parameters (should be > 500)
- Divergent: Number of divergent transitions during sampling (should be 0)
- Tree Depth: Whether maximum tree depth was exceeded during sampling
- BFMI Issues: Whether low Bayesian Fraction of Missing Information was detected
- Index RMSE: Root mean squared error for fit to standardized CPUE index
- Mohn's $\rho$: Retrospective bias statistic (values close to 0 indicate low bias)
- MASE: Mean Absolute Scaled Error from hindcast cross-validation (< 1 indicates model outperforms naïve predictor)
- Coverage $D/D_{MSY}$: Percentage of retrospective peels where relative depletion estimates fall within full model credible intervals
- Coverage $U/U_{MSY}$: Percentage of retrospective peels where relative exploitation rate estimates fall within full model credible intervals

:::

\newpage

```{=html}
<br>
```

```{r}
#| label: calculate-parameter-credible-intervals
#| echo: false
#| warning: false
#| message: false

# Load required libraries
library(data.table)

# Read HMC samples for both models
hmc_baseline <- fread(file.path(proj_dir, "data", "output", "model_runs", "0001-2024cpueExPrior_0", "hmc_samples.csv"))
hmc_constrained <- fread(file.path(proj_dir, "data", "output", "model_runs", "0002-2024cpueDepPrior_0", "hmc_samples.csv"))

# Function to calculate summary statistics for parameters
calculate_parameter_summary <- function(hmc_data, param_name) {
  param_values <- hmc_data[variable == param_name]$value
  list(
    median = median(param_values, na.rm = TRUE),
    lower = quantile(param_values, 0.025, na.rm = TRUE),
    upper = quantile(param_values, 0.975, na.rm = TRUE)
  )
}

# Define all parameters from the CSV snippet (reordered)
all_parameters <- c("logK", "r", "sigmap", "shape", "sigmaf", "sigmao_add", "sigmao_sc", "x[37]")

# Calculate statistics for baseline model
baseline_estimates <- lapply(all_parameters, function(p) {
  calculate_parameter_summary(hmc_baseline, p)
})
names(baseline_estimates) <- all_parameters

# Calculate statistics for constrained model  
constrained_estimates <- lapply(all_parameters, function(p) {
  calculate_parameter_summary(hmc_constrained, p)
})
names(constrained_estimates) <- all_parameters

# Formatting functions
format_estimate <- function(stats, digits = 2) {
  sprintf(paste0("%.", digits, "f (%.", digits, "f-%.", digits, "f)"), 
          stats$median, stats$lower, stats$upper)
}

format_rmax <- function(stats) {
  sprintf("%.2f (%.2f-%.2f)", stats$median, stats$lower, stats$upper)
}

format_logK <- function(stats) {
  sprintf("%.1f (%.1f-%.1f)", stats$median, stats$lower, stats$upper)
}
```

::: {.landscape}

Table: Posterior estimates with 95% credible intervals for all BSPM parameters {#tbl-param-hmc}

| Model | *log(K)*   | $R_{max}$ | $\sigma_P$ | *Shape ($n$)* | $\sigma_F$ | $\sigma_{O,add}$ | $\sigma_{O}$ | $x_{1988}$ |
|-------|------------|---------------|----------------|-----------------|----------------|---------------------|-------------------|-------------------|
| `0001` | `r format_logK(baseline_estimates$logK)` | `r format_rmax(baseline_estimates$r)` | `r format_estimate(baseline_estimates$sigmap)` | `r format_estimate(baseline_estimates$shape)` | `r format_estimate(baseline_estimates$sigmaf)` | `r format_estimate(baseline_estimates$sigmao_add)` | `r format_estimate(baseline_estimates$sigmao_sc)` | `r format_estimate(baseline_estimates[["x[37]"]])` |
| `0002` | `r format_logK(constrained_estimates$logK)` | `r format_rmax(constrained_estimates$r)` | `r format_estimate(constrained_estimates$sigmap)` | `r format_estimate(constrained_estimates$shape)` | `r format_estimate(constrained_estimates$sigmaf)` | `r format_estimate(constrained_estimates$sigmao_add)` | `r format_estimate(constrained_estimates$sigmao_sc)` | `r format_estimate(constrained_estimates[["x[37]"]])` |

**Parameter Definitions:**

`0001` corresponds to the `0001-2024cpueExPrior` model

`0002` corresponds to the `0002-2024cpueDepPrior` model

- *log(K)*: Natural logarithm of carrying capacity (total numbers)
- $R_{max}$: Maximum intrinsic rate of population increase (per year)  
- $\sigma_P$: Process error standard deviation
- *Shape ($n$)*: Pella-Tomlinson production function shape parameter
- $\sigma_F$: Fishing mortality variability standard deviation
- $\sigma_{O,add}$: Extra estimated observation error component
- $\sigma_{O}$: Total observation error (input + additional)
- $x_{1988}$: Population depletion in 1988 (year 37 of model period)

:::

\newpage

```{=html}
<br>
```

# Figures {#sec-figures}

```{r}
#| label: fig-annual-catch
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Annual catch of Southwest Pacific Ocean striped marlin (1952-2022). Catch data shows initial low removals in early years, a peak in 1954, followed by relatively stable catches with a slight decline in recent decades."

library(data.table)
library(ggplot2)

# Read catch data
catch_dt = fread(file.path(proj_dir, "data", "input", "catch.csv"))

# Process annual catch data (converting to thousands of fish)
catch_annual = catch_dt[, .(total_catch = sum(Obs * 1000)), by = .(year = floor(Time))]
setorder(catch_annual, year)

# Create histogram of annual catch
ggplot(catch_annual, aes(x = year, y = total_catch)) +
  geom_col(fill = "gray60", alpha = 0.8, width = 0.8) +
  geom_hline(yintercept=0) +
  scale_x_continuous(breaks = seq(1950, 2020, 10), 
                     limits = c(1950, 2025)) +
  scale_y_continuous(labels = scales::comma_format(scale = 1e-3, suffix = "K"),
                     expand = expansion(mult = c(0, 0.05))) +
  labs(x = "Year",
       y = "Annual Catch (numbers)") +
  theme(
    panel.background = element_rect(fill = "white", color = "black", linetype = "solid"),
    panel.grid.major = element_line(color = 'gray70', linetype = "dotted"), 
    panel.grid.minor = element_line(color = 'gray70', linetype = "dotted"),
    strip.background = element_rect(fill = "white"),
    legend.key = element_rect(fill = "white")
  )
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-idx-fit
#| echo: false
#| fig-cap: "Standardized index (black points), observation error (black bars), and posterior predicted model fits (colored lines) with associated 95% credible interval (colored shading)."
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots", "model_comparison", "comparisons", "comparison_index_fit_ppd.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-pushforward
#| echo: false
#| fig-cap: "Prior pushforward check for population depletion trajectories under different biological parameter filtering scenarios. Each line represents a simulated population trajectory colored by maximum intrinsic rate of increase ($R_{max}$). Left panel shows unfiltered $R_{max}$, middle panel shows filtered $R_{max}$, and right panel shows extreme filtering."
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots", "pushforward", "prior_push.sim_dep.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-rmax-prior
#| echo: false
#| fig-cap: "Prior distributions for maximum intrinsic rate of population increase $R_{max}$. Upper panel: Gray histogram is the $R_{max}$ values from the numerical simulation which meet baseline filtering levels. Red line is fitted lognormal distribution. Middle panel: Gray histogram is the $R_{max}$ values from the numerical simulation which meet extreme filtering levels. Dotted red line is fitted lognormal distribution. Bottom panel: Original distribution of $R_{max}$ values from numerical simulation (gray), those from viable populations (blue), and the two lognormal priors (red)."
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots", "pushforward", "prior.rmax.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-gedamke
#| echo: false
#| fig-cap: "Observed versus predicted mean weights from New Zealand recreational fishery data. Points show observed mean weights with error bars, colored lines show model predictions from the transitional mean weight model colored by relative spawning stock biomass (SSB) depletion."
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots", "depletion", "mean_weight_comparison.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-dep-prior
#| echo: false
#| fig-cap: "Prior distribution for relative depletion in 1988 derived from New Zealand recreational weight data. Light blue histogram shows depletion estimates from biological parameter combinations that successfully fit the transitional mean weight model. Blue dashed line shows kernel density estimate, red line shows fitted lognormal distribution used as prior in the depletion-constrained BSPM."
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots", "depletion", "prior_rel_dep_ssb.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-pred-catch
#| echo: false
#| fig-cap: "Time series of observed catch (black dots with uncertainty bounds) and model-predicted catch for two Bayesian surplus production models fitted to SWPO striped marlin data from 1950-2022. The left panel shows model `0001-2024cpueExPrior` (baseline model with expert priors) and the right panel shows model `0002-2024cpueDepPrior` (depletion-constrained model incorporating 1988 depletion prior from New Zealand recreational weight data). Colored lines represent posterior median predictions with shaded uncertainty bands showing 95% credible intervals."
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots", "predicted_catch.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-idx-residuals
#| echo: false
#| fig-cap: "Probability-integral transform (PIT) style residuals from each model (colored points) fit to the standardized index."
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots","model_comparison","comparisons", "comparison_index_fit_residuals.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-retro
#| echo: false
#| fig-cap: "Retrospective analysis for both models with respect to time series of depletion $D_t$, depletion relative to depletion at MSY $D_t/D_{MSY}$, exploitation rate $U_t$, and exploitation rate relative to the rate of exploitation that produces MSY $U_t/U_{MSY}$. The base model with data included through 2022 (black line – median; dark shading – 50% credible interval; light shading – 95% credible interval) is shown relative to the retrospective models. Colored lines correspond to the last year of index data and the colored point indicates the estimate in the last year of the retrospective peel."
#| out-width: "90%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots","retro_analysis.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-hcxval
#| echo: false
#| fig-cap: "Standardized indices of relative abundance used in the Bayesian Surplus Production Model. Open circles show observed values (standardized to mean of 1; black horizontal line) and the vertical bars indicate the observation error (95% confidence interval). One year ahead 'model-free' hindcast predictions are shown by the colored lines, where the color indicates the last year of index data seen by the model. The predicted value is shown one year-ahead with the colored point."
#| out-height: "90%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots","hcxval_analysis.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-prior-post
#| echo: false
#| fig-cap: 'Posterior parameter distributions (solid lines) for leading parameters (*log(K)*, $R_{max}$, $\sigma_P$, shape ($n$), $\sigma_F$, $\sigma_{O,add}$, and $\sigma_{O,sc}$), relative to their assumed prior distributions (dotted lines) for both models.'
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots","model_comparison","comparisons", "comparison_prior_posterior_params.png"))
```

\newpage

```{=html}
<br>
```

```{r}
#| label: fig-rmax-subsample-bio
#| echo: false
#| fig-cap: "Distributions of biological parameters (maximum age *max_age*, natural mortality reference *M_ref*, length at birth *L1*, asymptotic length *L2*, von Bertalanffy growth coefficient *vbk*, length at 50% maturity *l50*, sex ratio at birth *sex_ratio*, coefficient of variation in length *cv_len*, weight-length relationship parameters *weight_a* and *weight_b*, and steepness *h*) used in the rmax sub-sampling process. Original biological prior distribution (orange shading), distribution based on extreme filtering criteria following the prior pushforward analysis (green shading), and final sub-sampled distribution selected to match the posterior $R_{max}$ distribution (blue shading)."
#| out-width: "100%"
#| fig-pos: "H"

knitr::include_graphics(file.path(proj_dir, "plots", "rmax_subsampling_biological_parameters.png"))
```

\newpage

```{=html}
<br>
```

# Technical Annex {#sec-tech-annex}

Additional technical detail of population dynamics components used to solve the Euler-Lotka equation for $R_{max}$ and implement the Gedamke-Hoenig approach [@gedamke_estimating_2006] for using size composition data to estimate mortality in non-equilibrium situations. 

## Equilibrium Age-Structured Population Dynamics {#sec-equilibrium-dynamics}

### Survival {#sec-survival}

**Survival schedule** was calculated assuming constant natural mortality:

$l_a = \begin{cases} 
1 & \text{if } a = 1 \\
l_{a-1} \times \exp(-M_{ref}) & \text{if } 1 < a < A_{max} \\
\frac{l_{A_{max}-1}}{1-\exp(-M_{ref})} & \text{if } a = A_{max} \text{ (plus group)}
\end{cases}$

### Fecundity {#sec-fecundity-calculation}

Reproductive output incorporated biological constraints:
$$f_a = \frac{\psi_a \times W_a \times s}{\rho}$$

where:
- $\psi_a$ = proportion mature at age $a$
- $W_a$ = weight at age $a$ (proxy for reproductive capacity)
- $s$ = sex ratio (proportion female)
- $\rho$ = reproductive cycle (years between spawning events)

**Maturity-at-age** was derived from length-based logistic maturity:
$$\psi_L = \frac{\exp(a_{mat} + b_{mat} \times L)}{1 + \exp(a_{mat} + b_{mat} \times L)}$$
where $b_{mat} = -a_{mat}/L_{50}$, then integrated over the length-at-age distribution to obtain $\psi_a$.

**Length-at-age** followed the Francis parameterization:
$$L_a = L_1 + (L_2 - L_1) \times \frac{1 - \exp(-k(a - age_1))}{1 - \exp(-k(age_2 - age_1))}$$

with length variability modeled using probability density functions linking length bins to ages.

**Weight-at-age** used the allometric relationship:
$$W_a = a_w \times L_a^{b_w}$$

### Stock-Recruitment Relationship {#sec-stock-recruitment}

The slope at the origin of the stock-recruitment curve was:
$$\alpha = \frac{4h}{(1-h)\phi_0}$$

The calculation incorporated steepness ($h$) through the Beverton-Holt stock-recruitment relationship. Spawners-per-recruit in the unfished state was:
$$\phi_0 = \sum_{a=1}^{A_{max}} l_a f_a$$

This $\alpha$ parameter links the intrinsic rate of increase to recruitment compensation, ensuring that $R_{max}$ estimates reflect realistic population productivity under the assumed stock-recruitment dynamics.

Successful simulations (those yielding $R_{max} > 0$ and $R_{max} < 1.5$) were filtered to create a plausible prior distribution (@fig-pushforward). The resulting distribution was fitted to a lognormal prior for use in the BSPM (@fig-rmax-prior).

## Transitional Mean Weight Model {#sec-transitional-weight-model}

For each biological parameter combination, total mortality rates $Z_1$ and $Z_2$ were estimated by fitting a transitional mean weight model to observed temporal changes in recreational catch weights. The expected mean weight during the transition follows:

$$\bar{W}(d) = W_{\infty} - \frac{Z_1 Z_2 (W_{\infty} - W_c) [Z_1 + k + (Z_2 - Z_1)e^{-(Z_2+k)d}]}{(Z_1 + k)(Z_2 + k)[Z_1 + (Z_2 - Z_1)e^{-Z_2 d}]}$$

where:
- $d$ = time since mortality change (years after 1952)
- $W_{\infty}$ = asymptotic weight from growth parameters
- $W_c$ = weight at first capture (corresponding to $L_c$)
- $k$ = von Bertalanffy growth coefficient

The mortality parameters were estimated in a likelihood framework by maximizing the likelihood of the observed mean weights given a time series of predicted mean weights $\bar{W}(d)$. Optimization was constrained such that $Z_1, Z_2 \geq M_{ref}$ to ensure biologically realistic mortality estimates.
